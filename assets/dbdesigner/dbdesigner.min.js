/**
 * jQuery Plugin: DbDesigner
 *
 * An interactive table editor for JSON-based database schema definitions.
 * Supports inline editing, adding and deleting of tables, fields and relations,
 * visual structure navigation, validation, and real-time updates.
 *
 * Designed to simplify schema modeling in client-side applications and enable
 * live synchronization with external data sources or local storage.
 *
 * @author Daniel Dahme
 * @link https://github.com/ddbase3/DbDesigner
 * @version 1.0.0
 */
!function(e){e.fn.dbdesigner=function(t){var n=e.extend({onchange:function(){}},t),i=this,a=[],o=[],l=e('<ul class="context-menu"></ul>').css({position:"absolute","z-index":1e3,display:"none",background:"#fff",border:"1px solid #ccc",padding:"5px",listStyle:"none","line-height":1.5,"font-size":"13px","font-family":"Arial, sans-serif",cursor:"pointer"}).appendTo("body"),d=i.width(),f=i.height(),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("width",d),r.setAttribute("height",f),r.setAttribute("viewBox","0 0 "+d+" "+f),r.setAttribute("xmlns","http://www.w3.org/2000/svg"),r.classList.add("relationship-lines"),i[0].appendChild(r);var m=e("svg",i);function s(){var e=p();n.onchange(e)}function p(){return{data:a.map((e=>({id:e.id,name:e.name,fields:e.fields.map((e=>({name:e.name,type:e.type}))),primaryKeys:[...e.primaryKeys],position:{...e.position}}))),foreignKeys:o.map((e=>({from:{tableId:e.from.tableId,tableName:e.from.tableName,fieldName:e.from.fieldName},to:{tableId:e.to.tableId,tableName:e.to.tableName,fieldName:e.to.fieldName}})))}}function c(e,t,n){e.fields.find((e=>e.name===t))||e.fields.push({name:t,type:n})}function u(t,n,d,f){const r=a.find((e=>e.id===n));if(r)return r;var m={id:n,name:t,fields:[],primaryKeys:[],position:{x:d,y:f}},p=e('<div class="table-box"></div>').css({position:"absolute",left:d+"px",top:f+"px","min-width":"100px",border:"1px solid black",background:"#f9f9f9",cursor:"pointer"}).data("tableid",m.id).appendTo(i).draggable({containment:"parent",handle:".table-title",drag:function(e,t){g()},stop:function(e,t){m.position.x=t.position.left,m.position.y=t.position.top,g(),s()}}),u=(e('<div class="table-title"></div>').css({padding:"4px 5px",background:"#ddd","font-weight":"bold","font-size":"14px"}).text(t).appendTo(p).on("contextmenu",(function(t){t.preventDefault(),function(t,n,i,d){l.empty(),e("<li>Tabellenname √§ndern</li>").appendTo(l).on("click",(function(){var e=prompt("Neuer Tabellenname:",i.name);e&&(i.name=e,d.find(".table-title").text(e),s()),l.hide()})),e("<li>Feld hinzuf√ºgen</li>").appendTo(l).on("click",(function(){var e=prompt("Feldname eingeben:");e&&(c(i,e,"TEXT"),y(i),s()),l.hide()})),e("<li>Tabelle l√∂schen</li>").appendTo(l).on("click",(function(){var e;d.remove(),a=a.filter((e=>e.id!==i.id)),e=i.id,o=o.filter((t=>{const n=t.from.tableId===e,i=t.to.tableId===e;return!n&&!i||(console.warn(`üóë Entferne Foreign Key von ${t.from.tableName}.${t.from.fieldName} zu ${t.to.tableName}.${t.to.fieldName}`),!1)})),g(),s(),g(),s(),l.hide()})),l.css({top:n+"px",left:t+"px",display:"block"})}(t.pageX,t.pageY,m,p)})),e('<ul class="table-fields"></ul>').css({padding:0,margin:0,"list-style":"none"}).appendTo(p).sortable({stop:function(t,n){var i=[],a={};u.children().each((function(t,n){var o=e(n).data("fieldname"),l=m.fields.find((e=>e.name===o));l&&(l.$element=e(n),a[l.name]=l,i.push(l))})),m.fields=i,o.forEach((e=>{e.from.tableId===m.id&&a[e.from.fieldName]&&(e.from.$element=a[e.from.fieldName].$element),e.to.tableId===m.id&&a[e.to.fieldName]&&(e.to.$element=a[e.to.fieldName].$element)})),g(),s()}}));return m.$element=p,m.$fields=u,a.push(m),m}function b(){o.forEach((e=>{let t=a.find((t=>t.id===e.from.tableId)),n=a.find((t=>t.id===e.to.tableId));if(t){let n=t.fields.find((t=>t.name===e.from.fieldName));n?e.from.$element=n.$element:console.warn(`‚ö† Foreign Key von ${e.from.fieldName} nicht gefunden.`)}if(n){let t=n.fields.find((t=>t.name===e.to.fieldName));t?e.to.$element=t.$element:console.warn(`‚ö† Foreign Key zu ${e.to.fieldName} nicht gefunden.`)}}))}function h(e,t,n,i){if(e==n&&t==i)return;if(!o.find((a=>a.from.tableId===e&&a.from.fieldName===t&&a.to.tableId===n&&a.to.fieldName===i||a.from.tableId===n&&a.from.fieldName===i&&a.to.tableId===e&&a.to.fieldName===t))){var l=a.find((t=>t.id===e)),d=a.find((e=>e.id===n));if(l&&d){var f=l.fields.find((e=>e.name===t)),r=d.fields.find((e=>e.name===i));f&&r&&(o.push({from:{tableId:l.id,tableName:l.name,fieldName:f.name,$element:f.$element},to:{tableId:d.id,tableName:d.name,fieldName:r.name,$element:r.$element}}),b())}}}function y(t){t.$fields.empty(),t.fields.forEach(((n,i)=>{var a=e('<li class="field-item"></li>').css({margin:0,padding:"5px",borderBottom:"1px solid #ddd",cursor:"grab"}).attr("data-fieldname",n.name).appendTo(t.$fields).on("contextmenu",(function(d){d.preventDefault(),n.$element=a,function(t,n,i,a,d){l.empty(),e("<li>Feld hinzuf√ºgen</li>").appendTo(l).on("click",(function(){var e=prompt("Feldname eingeben:");e&&(c(i,e,"TEXT"),y(i),s()),l.hide()})),e("<li>Feldname √§ndern</li>").appendTo(l).on("click",(function(){var e=prompt("Neuer Feldname:",a.name);e&&(a.name=e,y(i),s()),l.hide()})),e("<li>Feldtyp √§ndern</li>").appendTo(l).on("click",(function(){var e=prompt("Neuer Feldtyp:",a.type);e&&(a.type=e,y(i),s()),l.hide()})),i.primaryKeys.includes(a.name)?e("<li>Primary Key entfernen</li>").appendTo(l).on("click",(function(){i.primaryKeys=i.primaryKeys.filter((e=>e!==a.name)),y(i),s(),l.hide()})):e("<li>Als Primary-Key definieren</li>").appendTo(l).on("click",(function(){i.primaryKeys.push(a.name),y(i),s(),l.hide()}));e("<li>Feld l√∂schen</li>").appendTo(l).on("click",(function(){var e,t;i.fields.splice(d,1),y(i),e=i.id,t=a.name,o=o.filter((n=>{const i=n.from.tableId===e&&n.from.fieldName===t,a=n.to.tableId===e&&n.to.fieldName===t;return!i&&!a||(console.warn(`üóë Entferne Foreign Key von ${n.from.tableName}.${n.from.fieldName} zu ${n.to.tableName}.${n.to.fieldName}`),!1)})),g(),s(),g(),s(),l.hide()})),e("<li>Als Fremdschl√ºssel definieren</li>").appendTo(l).on("click",(function(){l.hide();var t=i.id,n=a.name;e(document).on("click",".field-item",(function i(){var a=e(this),o=a.data("fieldname"),l=a.closest(".table-box").data("tableid");h(t,n,l,o),e(document).off("click",".field-item",i),g(),s()}))})),e("<li>Fremdschl√ºssel l√∂schen</li>").appendTo(l).on("click",(function(){l.hide();var e=a.name,t=i.id;o=o.filter((n=>{const i=n.from.tableId===t&&n.from.fieldName===e,a=n.to.tableId===t&&n.to.fieldName===e;return!(i||a)})),g(),s()})),l.css({top:n+"px",left:t+"px",display:"block"})}(d.pageX,d.pageY,t,n,i)}));n.$element=a,t.primaryKeys.includes(n.name)&&a.css("font-weight","bold"),e('<div class="field-name"></div>').text(n.name).css({"font-size":"13px"}).appendTo(a),e('<div class="field-type"></div>').text(n.type).css({"font-size":"11px","text-align":"right",color:"#666"}).appendTo(a)})),b()}function g(){m.empty();var t=i.offset();o.forEach((n=>{var i=e(n.from.$element),a=e(n.to.$element),o=i.offset(),l=a.offset();if(o&&l){var d=o.left-t.left+i.width()/2,f=o.top-t.top+i.height()/2,m=l.left-t.left+a.width()/2,s=l.top-t.top+a.height()/2,p=m>d?200:-200,c=p*(Math.abs(d-m)<Math.max(i.width(),a.width())?1:-1),u=document.createElementNS("http://www.w3.org/2000/svg","path");u.setAttribute("d",`M ${d} ${f} C ${d+p} ${f}, ${m+c} ${s}, ${m} ${s}`),u.setAttribute("stroke","#333"),u.setAttribute("fill","transparent"),u.setAttribute("stroke-width","1"),r.appendChild(u)}}))}return this.clear=function(){i.find(".table-box").remove(),a=[],o=[],g(),s()},this.initializeFromData=function(e){e.data&&e.data.forEach((e=>{var t=u(e.name,e.id,e.position.x,e.position.y);e.fields.forEach((e=>{c(t,e.name,e.type)})),e.primaryKeys.forEach((e=>{t.fields.some((t=>t.name===e))&&t.primaryKeys.push(e)})),y(t)})),e.foreignKeys&&e.foreignKeys.forEach((e=>{h(e.from.tableId,e.from.fieldName,e.to.tableId,e.to.fieldName)})),g(),s()},this.getData=function(){return p()},e(document).on("click",(function(){l.hide()})),i.on("contextmenu",(function(t){var n,a;t.preventDefault(),e(t.target).closest(".table-box").length||(n=t.pageX,a=t.pageY,l.empty(),e("<li>Tabelle erstellen</li>").appendTo(l).on("click",(function(){var e=prompt("Tabellenname eingeben:");if(e){var t=i.offset(),o=n-t.left,d=a-t.top;u(e,Date.now(),o,d),g(),s()}l.hide()})),l.css({top:a+"px",left:n+"px",display:"block"}))})),this}}(jQuery);
